# Как создать (удалить) файл подкачки (SWAP) в Linux (На примере Ubuntu 20.04 на бесплатном VPS - сервере от Oracle)

**_Ниже представлена моя "Шпаргалка" (CheatSheet)_ ;-)**

>Как известно, уровень Oracle Always Free включает в себя всего 1 Гбайт оперативной памяти, чего зачастую вполне достаточно для одновременной работы нескольких сервисов. Но при запуске сборки контейнеров, или скриптов установки пакетов и их настройки, ваша виртуальная машина может просто зависнуть из-за нехватки оперативной памяти. Связано это с тем, что в установленной нами Ubuntu 20.04 отсутствует активный файл подкачки (swap).

Убедимся в этом, для чего ведём в терминале:

`free -h`

![alt](https://cs14.pikabu.ru/post_img/2021/02/10/6/1612945435142195789.png)

Проверяем, что у нас достаточно места  для добавления раздела swap:

`df -h`

![alt](https://cs14.pikabu.ru/post_img/2021/02/10/6/1612945712121190220.png)

>Мнений о необходимом объёме раздела  swap множество ))) Мы будем придерживаться того, что этот объем должен быть равен или быть в два раза больше объема оперативной памяти вашей системы. Т.е. в нашем случае это будет объём 2 Гб. (Из практики известно, что иметь swap более 4 Гб зачастую бессмысленно).

Разместим файл нужного размера **swapfile** в директории **root (/)** с помощью программы **fallocate**:

`sudo fallocate -l 2G /swapfile`

Проверим, что сработало:

`ls -lh /swapfile`

![alt](https://cs13.pikabu.ru/post_img/2021/02/10/6/1612946316182173163.png)

Делаем файл подкачки доступным только для root:

`sudo chmod 600 /swapfile`

Проверим, что сработало:

`ls -lh /swapfile`

![alt](https://cs13.pikabu.ru/post_img/2021/02/10/6/1612946495181789420.png)

Говорим системе, что этот раздел у нас для файла подкачки:

`sudo mkswap /swapfile`

![alt](https://cs14.pikabu.ru/post_img/2021/02/10/6/1612946612125585396.png)

Включаем его:

`sudo swapon /swapfile`

Проверим, что всё ok:

`sudo swapon --show`

![alt](https://cs14.pikabu.ru/post_img/2021/02/10/6/1612946800156073564.png)

>Следующие две команды позволят использовать файл подкачки не только для текущего сеанса, но и после перезагрузки системы.

Сделаем резервную копию конфигурационного файла fstab:

`sudo cp /etc/fstab /etc/fstab.bak`

Добавим в него информацию о файле подкачки:

`echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab`

>Вот в принципе и В С Ё . . . )))

# Ну можно ещё настроить swap, что бы ядро по возможности избегало использование файла подкачки.

>**Swappiness** - это свойство ядра Linux, которое определяет, как часто система будет использовать пространство подкачки. Подкачка может иметь значение от 0 до 100.

Проверим текущее значение:

`cat /proc/sys/vm/swappiness`

![alt](https://cs12.pikabu.ru/post_img/2021/02/10/6/161294845111851177.png)

60 - считается нормой для домашнего компьютера, но для сервера желательно это значение свести к минимуму, например - 10:

`sudo sysctl vm.swappiness=10`

![alt](https://cs12.pikabu.ru/post_img/2021/02/10/6/1612948673190429725.png)

Сохраним это значение и после перезапуска системы, для этого открываем файл /etc/sysctl.conf:

`sudo nano /etc/sysctl.conf`

Добавляем в конец эту строчку:

`vm.swappiness = 10`

![alt](https://cs13.pikabu.ru/post_img/2021/02/10/6/1612951063145451337.png)

Сохраняем и закрываем файл, нажав CTRL + X, Y, а затем ENTER.

# Ну, а если по какой-то причине решите удалить файл подкачки, то нужно сделать следующее:

- Деактивируйте swap:

`sudo swapoff -v /swapfile`

- Удалите запись файла подкачки  из /etc/fstab файла:

`sudo nano /etc/fstab`

![alt](https://cs14.pikabu.ru/post_img/2021/02/10/6/1612950421148616145.png)

Сохраняем и закрываем файл, нажав CTRL + X, Y, а затем ENTER.

- Удалите сам файл подкачки с помощью rmкоманды:

`sudo rm /swapfile`

>На этом у меня В С Ё !!! )))
